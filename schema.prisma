// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User roles enum
enum UserRole {
  ADMIN
  TEACHER
}

// Student status enum
enum StudentStatus {
  ACTIVE
  INACTIVE
  GRADUATED
  TRANSFERRED
  SUSPENDED
}

// Grade status enum
enum GradeStatus {
  PASS
  FAIL
  PENDING
}

// Users table - Only for teachers and admins
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String?  @unique
  password  String   // Hashed password
  role      UserRole
  firstName String
  lastName  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  teacher   Teacher?
  createdStudents Student[] @relation("StudentCreatedBy")
  updatedStudents Student[] @relation("StudentUpdatedBy")
  grades    Grade[]   @relation("GradeEnteredBy")

  @@map("users")
}

// Teachers table - linked to User
model Teacher {
  id           String   @id @default(cuid())
  userId       String   @unique
  teacherId    String   @unique // School-assigned teacher ID
  dateOfBirth  DateTime?
  gender       String?
  address      String?
  phone        String?
  joiningDate  DateTime @default(now())
  subjects     String[] // Array of subjects they teach

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  classes      Class[]
  attendances  Attendance[]

  @@map("teachers")
}

// Students table - just data records, not system users
model Student {
  id           String        @id @default(cuid())
  studentId    String        @unique // School-specific student ID
  firstName    String
  lastName     String
  middleName   String?
  dateOfBirth  DateTime
  gender       String
  address      String
  phone        String?
  emergencyContact String?
  parentName   String?       // Parent/Guardian name
  parentPhone  String?       // Parent/Guardian phone
  parentEmail  String?       // Parent/Guardian email
  admissionDate DateTime     @default(now())
  status       StudentStatus @default(ACTIVE)
  currentClass String?       // Current class/grade
  section      String?       // Class section
  rollNumber   Int?
  profilePhoto String?       // URL to profile photo
  portfolio    Json?         // JSON field for portfolio data (achievements, etc.)

  // Audit fields
  createdById  String
  updatedById  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  createdBy    User          @relation("StudentCreatedBy", fields: [createdById], references: [id])
  updatedBy    User          @relation("StudentUpdatedBy", fields: [updatedById], references: [id])
  enrollments  Enrollment[]
  attendances  Attendance[]
  grades       Grade[]
  promotions   Promotion[]

  @@map("students")
}

// Classes/Courses table
model Class {
  id          String   @id @default(cuid())
  className   String   @unique // e.g., "Grade 9-A", "Class 10-B"
  subject     String   // Subject name
  teacherId   String
  academicYear String
  schedule    String?  // Class schedule (JSON or text)
  room        String?
  capacity    Int?

  // Relations
  teacher     Teacher      @relation(fields: [teacherId], references: [id])
  enrollments Enrollment[]
  attendances Attendance[]
  grades      Grade[]

  @@map("classes")
}

// Student enrollments in classes
model Enrollment {
  id        String   @id @default(cuid())
  studentId String
  classId   String
  enrolledAt DateTime @default(now())
  isActive  Boolean  @default(true)

  // Relations
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId])
  @@map("enrollments")
}

// Grades/Marks - core functionality for RMS
model Grade {
  id          String      @id @default(cuid())
  studentId   String
  classId     String
  enteredById String      // Teacher who entered the grade
  examType    String      // QUIZ, MIDTERM, FINAL, ASSIGNMENT, etc.
  subject     String
  marks       Float
  totalMarks  Float
  percentage  Float       // Calculated percentage
  grade       String?     // A+, A, B+, etc.
  status      GradeStatus @default(PENDING)
  examDate    DateTime
  remarks     String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  student     Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class       Class       @relation(fields: [classId], references: [id])
  enteredBy   User        @relation("GradeEnteredBy", fields: [enteredById], references: [id])

  @@map("grades")
}

// Student promotions/class changes - automated with manual override
model Promotion {
  id              String   @id @default(cuid())
  studentId       String
  fromClass       String
  toClass         String?  // null if student failed/retained
  academicYear    String
  promotionDate   DateTime @default(now())
  isPromoted      Boolean  // true if promoted, false if retained
  isAutomatic     Boolean  @default(true) // false if manually overridden
  overrideReason  String?  // reason for manual override
  approvedById    String?  // admin who approved manual override
  finalGrade      String?  // Overall grade for the year
  totalMarks      Float?   // Total marks obtained
  totalPossible   Float?   // Total marks possible
  percentage      Float?   // Overall percentage

  // Relations
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  approvedBy      User?    @relation("PromotionApprovedBy", fields: [approvedById], references: [id])

  @@map("promotions")
}

// Add the relation back to User model for promotions
model User {
  // ... existing fields ...
  approvedPromotions Promotion[] @relation("PromotionApprovedBy")
}

// Academic years
model AcademicYear {
  id        String   @id @default(cuid())
  year      String   @unique // e.g., "2024-2025"
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(false)

  @@map("academic_years")
}

// System settings - only accessible by admins
model Setting {
  id    String @id @default(cuid())
  key   String @unique
  value String

  @@map("settings")
}

// Report generation logs
model ReportGeneration {
  id           String   @id @default(cuid())
  reportType   String   // INDIVIDUAL_STUDENT, CLASS_REPORT, etc.
  generatedById String
  parameters   Json     // Parameters used for report generation
  filePath     String?  // Path to generated report file
  createdAt    DateTime @default(now())

  // Relations
  generatedBy  User     @relation("ReportGeneratedBy", fields: [generatedById], references: [id])

  @@map("report_generations")
}

// Add relation back to User model
model User {
  // ... existing fields ...
  generatedReports ReportGeneration[] @relation("ReportGeneratedBy")
}